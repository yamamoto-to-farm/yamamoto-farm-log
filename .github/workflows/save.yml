name: Save log

on:
  workflow_dispatch:
    inputs:
      payload:
        description: "UI から送られてくる JSON データ"
        required: true
        type: string

jobs:
  save:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout data repo
        uses: actions/checkout@v4
        with:
          repository: yamamoto-to-farm/yamamoto-farm-log
          token: ${{ secrets.FARM_DATA_TOKEN }}

      - name: Parse payload
        id: parse
        run: |
          echo '${{ inputs.payload }}' > payload.json
          cat payload.json

      - name: Extract fields
        id: extract
        run: |
          TYPE=$(jq -r '.type' payload.json)
          DATE=$(jq -r '.dateStr' payload.json)
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT

      # ============================================
      # JSON 保存（配列として蓄積）
      # ============================================
      - name: Save JSON (append to array)
        run: |
          TYPE=${{ steps.extract.outputs.type }}
          DATE=${{ steps.extract.outputs.date }}
          JSON_FILE="logs/$TYPE/$DATE.json"

          mkdir -p logs/$TYPE

          # 既存 JSON を読み込み（なければ空配列）
          if [ -f "$JSON_FILE" ]; then
            EXISTING=$(cat "$JSON_FILE")
          else
            EXISTING="[]"
          fi

          # payload.json を配列に追加
          UPDATED=$(jq -s '.[0] + [.[1]]' <(echo "$EXISTING") payload.json)

          # 上書き保存（配列として）
          echo "$UPDATED" > "$JSON_FILE"

      # ============================================
      # CSV 保存（追記）
      # ============================================
      - name: Save CSV
        run: |
          TYPE=${{ steps.extract.outputs.type }}
          CSV_LINE=$(jq -r '.csv' payload.json)

          mkdir -p logs/$TYPE
          CSV_FILE="logs/$TYPE/all.csv"

          echo "$CSV_LINE" >> "$CSV_FILE"

      # ============================================
      # Commit & Push
      # ============================================
      - name: Commit & Push
        run: |
          git config user.name "farm-bot"
          git config user.email "actions@github.com"
          git add logs/*
          git commit -m "save ${{ steps.extract.outputs.type }} log for ${{ steps.extract.outputs.date }}"
          git push
