name: Save harvest log

on:
  workflow_dispatch:
    inputs:
      payload:
        description: "UI から送られてくる JSON データ"
        required: true
        type: string

jobs:
  save:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout data repo
        uses: actions/checkout@v4
        with:
          repository: yamamoto-to-farm/yamamoto-farm-log   # ★ 修正
          token: ${{ secrets.FARM_DATA_TOKEN }}

      - name: Parse payload
        id: parse
        run: |
          echo '${{ inputs.payload }}' > payload.json
          cat payload.json

      - name: Extract fields
        id: extract
        run: |
          TYPE=$(jq -r '.type' payload.json)
          DATE=$(jq -r '.dateStr' payload.json)
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT

      - name: Save JSON
        run: |
          mkdir -p logs/${{ steps.extract.outputs.type }}
          cp payload.json logs/${{ steps.extract.outputs.type }}/${{ steps.extract.outputs.date }}.json

      - name: Save CSV
        run: |
          TYPE=${{ steps.extract.outputs.type }}
          CSV_LINE=$(jq -r '.csv' payload.json)

          mkdir -p logs/$TYPE
          CSV_FILE="logs/$TYPE/all.csv"

          echo "$CSV_LINE" >> "$CSV_FILE"

      - name: Commit & Push
        run: |
          git config user.name "farm-bot"
          git config user.email "actions@github.com"
          git add logs/*
          git commit -m "save ${{ steps.extract.outputs.type }} log for ${{ steps.extract.outputs.date }}"
          git push
