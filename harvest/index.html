<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>収穫ログ - 山本農園</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 20px; background:#f5f5f5; }
    h1 { margin-bottom: 16px; }
    h2 { margin-top: 24px; }
    .field { margin-bottom: 12px; }
    .field label { display:block; margin-bottom:4px; }
    .box { padding: 15px; border: 1px solid #ccc; margin-top: 10px; background:#fff; }
    input, select, textarea {
      width: 100%; padding: 8px; box-sizing: border-box; font-size: 14px;
    }
    button {
      width: 100%; padding: 12px; font-size: 16px;
      background: #2f855a; color: #fff; border: none; border-radius: 4px;
      margin-top: 20px;
    }
    button:active { opacity: 0.8; }

    #field_auto {
      background: #fff3b0;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <h1>収穫ログ</h1>

  <!-- 日付 -->
  <div class="field">
    <label for="harvestDate">収穫日</label>
    <input type="date" id="harvestDate">
  </div>

  <div class="field">
    <label for="shippingDate">出荷申請日</label>
    <input type="date" id="shippingDate">
  </div>

  <!-- 作業者 -->
  <h2>作業者</h2>
  <div class="box" id="workers_box"></div>

  <div class="box">
    <label for="temp_workers">単発バイト（カンマ区切り）</label>
    <input id="temp_workers" placeholder="例：佐藤さん, 田中さん">
  </div>

  <!-- 圃場 -->
  <h2>圃場</h2>
  <div class="box">

    <label>自動判定（推定）</label>
    <input id="field_auto" readonly>

    <label style="margin-top:10px;">
      <input type="checkbox" id="field_confirm">
      この圃場で確定する
    </label>

    <hr style="margin: 15px 0;">

    <label>エリア選択</label>
    <select id="field_area">
      <option value="">エリアを選択</option>
    </select>

    <label>圃場選択</label>
    <select id="field_manual">
      <option value="">エリアを選んでください</option>
    </select>
  </div>

  <!-- 紐づける定植記録 -->
  <h2>紐づける定植記録</h2>
  <div class="box">
    <label for="plantingRef">定植記録（収穫予定 ±1ヶ月）</label>
    <select id="plantingRef">
      <option value="">該当する定植記録を選択</option>
    </select>
  </div>

  <!-- 収穫量・特記事項 -->
  <h2>収穫量・特記事項</h2>
  <div class="box">
    <div class="field">
      <label for="amount">収穫量（基）</label>
      <input type="number" id="amount" inputmode="numeric">
    </div>
    <div class="field">
      <label for="issue">特記事項</label>
      <textarea id="issue" rows="3" placeholder="病害虫・欠株・その他メモなど"></textarea>
    </div>
  </div>

  <!-- 保存ボタン -->
  <button type="button" onclick="saveHarvest()">GitHub に保存する</button>

  <!-- UI 初期化 & 保存処理 -->
  <script type="module">
    import {
      createWorkerCheckboxes,
      createFieldSelector,
      autoDetectField,
      getSelectedWorkers
    } from "../common/ui.js";

    import { saveLog } from "../common/save/index.js";

    // ============================
    // UI 初期化
    // ============================
    createWorkerCheckboxes("workers_box");

    createFieldSelector("field_auto", "field_area", "field_manual")
      .then(() => {
        autoDetectField("field_auto", "field_area", "field_manual");
      });

    // ============================
    // 圃場の最終決定ロジック
    // ============================
    function getFinalField() {
      const auto = document.getElementById("field_auto").value;
      const manual = document.getElementById("field_manual").value;
      const confirmed = document.getElementById("field_confirm").checked;

      if (confirmed) return auto;
      if (manual) return manual;
      return auto;
    }

    // ============================
    // 定植CSV読み込み
    // ============================
    async function loadPlantingCSV() {
      const res = await fetch("https://naoki-yamamoto.github.io/yamamoto-farm-data/logs/planting/all.csv");
      const text = await res.text();

      const lines = text.trim().split("\n");
      const rows = lines.slice(1);

      return rows.map(line => {
        const cols = line.split(",");
        return {
          plantDate: cols[0],
          worker: cols[1],
          field: cols[2],
          variety: cols[3],
          quantity: cols[4],
          spacingRow: cols[5],
          spacingBed: cols[6],
          harvestPlanYM: cols[7],
          notes: cols[8]
        };
      });
    }

    // ============================
    // 収穫年月 ±1ヶ月
    // ============================
    function getHarvestYMRange(harvestDate) {
      const d = new Date(harvestDate);
      const list = [];

      for (let offset = -1; offset <= 1; offset++) {
        const tmp = new Date(d);
        tmp.setMonth(tmp.getMonth() + offset);
        const ym = `${tmp.getFullYear()}-${String(tmp.getMonth() + 1).padStart(2, "0")}`;
        list.push(ym);
      }

      return list;
    }

    // ============================
    // 定植記録候補を更新
    // ============================
    async function updatePlantingRefOptions() {
      const field = getFinalField();
      const harvestDate = document.getElementById("harvestDate").value;

      if (!field || !harvestDate) return;

      const plantingList = await loadPlantingCSV();
      const ymRange = getHarvestYMRange(harvestDate);

      const select = document.getElementById("plantingRef");
      select.innerHTML = "<option value=''>該当する定植記録を選択</option>";

      plantingList
        .filter(p => p.field === field && ymRange.includes(p.harvestPlanYM))
        .forEach(p => {
          const id = p.plantDate.replace(/-/g, "");
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = `${p.plantDate} / ${p.variety} / ${p.quantity}株`;
          select.appendChild(opt);
        });
    }

    // 圃場 or 収穫日が変わったら更新
    document.getElementById("field_manual").addEventListener("change", updatePlantingRefOptions);
    document.getElementById("field_auto").addEventListener("change", updatePlantingRefOptions);
    document.getElementById("harvestDate").addEventListener("change", updatePlantingRefOptions);

    // ============================
    // 入力データ収集
    // ============================
    function collectHarvestData() {
      return {
        harvestDate: document.getElementById("harvestDate").value,
        shippingDate: document.getElementById("shippingDate").value,
        worker: getSelectedWorkers("workers_box", "temp_workers"),
        field: getFinalField(),
        amount: document.getElementById("amount").value,
        issue: document.getElementById("issue").value,
        plantingRef: document.getElementById("plantingRef").value
      };
    }

    // ============================
    // 保存処理
    // ============================
    async function saveHarvestInner() {
      const data = collectHarvestData();

      if (!data.harvestDate) {
        alert("収穫日を入力してください");
        return;
      }

      const dateStr = data.harvestDate.replace(/-/g, "");

      const csvLine = [
        data.harvestDate,
        data.shippingDate,
        data.worker,
        data.field,
        data.amount,
        data.issue.replace(/[\r\n,]/g, " "),
        data.plantingRef
      ].join(",");

      await saveLog("harvest", dateStr, data, csvLine);

      alert("GitHubに保存しました");
    }

    window.saveHarvest = saveHarvestInner;

    // 日付初期値
    const today = new Date().toISOString().slice(0, 10);
    document.getElementById("harvestDate").value = today;
    document.getElementById("shippingDate").value = today;
  </script>
</body>
</html>