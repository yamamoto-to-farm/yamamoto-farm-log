<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>åç©«ãƒ­ã‚° - å±±æœ¬è¾²åœ’</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 20px; background:#f5f5f5; }
    h1 { margin-bottom: 16px; }
    h2 { margin-top: 24px; }
    .field { margin-bottom: 12px; }
    .field label { display:block; margin-bottom:4px; }
    .box { padding: 15px; border: 1px solid #ccc; margin-top: 10px; background:#fff; }
    input, select, textarea {
      width: 100%; padding: 8px; box-sizing: border-box; font-size: 14px;
    }
    button {
      width: 100%; padding: 12px; font-size: 16px;
      background: #2f855a; color: #fff; border: none; border-radius: 4px;
      margin-top: 20px;
    }
    button:active { opacity: 0.8; }

    #field_auto {
      background: #fff3b0;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <h1>åç©«ãƒ­ã‚°</h1>

  <!-- æ—¥ä»˜ -->
  <div class="field">
    <label for="harvestDate">åç©«æ—¥</label>
    <input type="date" id="harvestDate">
  </div>

  <div class="field">
    <label for="shippingDate">å‡ºè·ç”³è«‹æ—¥</label>
    <input type="date" id="shippingDate">
  </div>

  <!-- ä½œæ¥­è€… -->
  <h2>ä½œæ¥­è€…</h2>
  <div class="box" id="workers_box"></div>

  <div class="box">
    <label for="temp_workers">å˜ç™ºãƒã‚¤ãƒˆï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
    <input id="temp_workers" placeholder="ä¾‹ï¼šä½è—¤ã•ã‚“, ç”°ä¸­ã•ã‚“">
  </div>

  <!-- åœƒå ´ -->
  <h2>åœƒå ´</h2>
  <div class="box">

    <label>è‡ªå‹•åˆ¤å®šï¼ˆæ¨å®šï¼‰</label>
    <input id="field_auto" readonly>

    <label style="margin-top:10px;">
      <input type="checkbox" id="field_confirm">
      ã“ã®åœƒå ´ã§ç¢ºå®šã™ã‚‹
    </label>

    <hr style="margin: 15px 0;">

    <label>ã‚¨ãƒªã‚¢é¸æŠ</label>
    <select id="field_area">
      <option value="">ã‚¨ãƒªã‚¢ã‚’é¸æŠ</option>
    </select>

    <label>åœƒå ´é¸æŠ</label>
    <select id="field_manual">
      <option value="">ã‚¨ãƒªã‚¢ã‚’é¸ã‚“ã§ãã ã•ã„</option>
    </select>
  </div>

  <!-- ç´ã¥ã‘ã‚‹å®šæ¤è¨˜éŒ² -->
  <h2>ç´ã¥ã‘ã‚‹å®šæ¤è¨˜éŒ²</h2>
  <div class="box">
    <label for="plantingRef">å®šæ¤è¨˜éŒ²ï¼ˆåç©«äºˆå®š Â±1ãƒ¶æœˆï¼‰</label>
    <select id="plantingRef">
      <option value="">è©²å½“ã™ã‚‹å®šæ¤è¨˜éŒ²ã‚’é¸æŠ</option>
    </select>
  </div>

  <!-- åç©«é‡ãƒ»ç‰¹è¨˜äº‹é … -->
  <h2>åç©«é‡ãƒ»ç‰¹è¨˜äº‹é …</h2>
  <div class="box">
    <div class="field">
      <label for="amount">åç©«é‡ï¼ˆåŸºï¼‰</label>
      <input type="number" id="amount" inputmode="numeric">
    </div>
    <div class="field">
      <label for="issue">ç‰¹è¨˜äº‹é …</label>
      <textarea id="issue" rows="3" placeholder="ç—…å®³è™«ãƒ»æ¬ æ ªãƒ»ãã®ä»–ãƒ¡ãƒ¢ãªã©"></textarea>
    </div>
  </div>

  <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
  <button type="button" onclick="saveHarvest()">GitHub ã«ä¿å­˜ã™ã‚‹</button>

  <!-- UI åˆæœŸåŒ– & ä¿å­˜å‡¦ç† -->
  <script type="module">
    import {
      createWorkerCheckboxes,
      createFieldSelector,
      autoDetectField,
      getSelectedWorkers
    } from "../common/ui.js";

    import { saveLog } from "../common/save/index.js";

    // ============================
    // UI åˆæœŸåŒ–
    // ============================
    createWorkerCheckboxes("workers_box");

    createFieldSelector("field_auto", "field_area", "field_manual")
      .then(() => {
        autoDetectField("field_auto", "field_area", "field_manual");

        // â˜… createFieldSelector ãŒ DOM ã‚’ä½œã‚Šçµ‚ã‚ã£ãŸå¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»˜ã‘ã‚‹
        document.getElementById("field_manual").addEventListener("change", updatePlantingRefOptions);
        document.getElementById("field_auto").addEventListener("change", updatePlantingRefOptions);
        document.getElementById("harvestDate").addEventListener("change", updatePlantingRefOptions);

        console.log("ğŸ”¥ ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²å®Œäº†");
      });

    // ============================
    // åœƒå ´ã®æœ€çµ‚æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯
    // ============================
    function getFinalField() {
      const auto = document.getElementById("field_auto").value;
      const manual = document.getElementById("field_manual").value;
      const confirmed = document.getElementById("field_confirm").checked;

      if (confirmed) return auto;
      if (manual) return manual;
      return auto;
    }

    // ============================
    // å®šæ¤CSVèª­ã¿è¾¼ã¿
    // ============================
    async function loadPlantingCSV() {
      const res = await fetch("../logs/planting/all.csv");
      const text = await res.text();

      const lines = text.trim().split("\n");
      const rows = lines.slice(1);

      const list = rows.map(line => {
        const cols = line.split(",");
        return {
          plantDate: cols[0],
          worker: cols[1],
          field: cols[2],
          variety: cols[3],
          quantity: cols[4],
          spacingRow: cols[5],
          spacingBed: cols[6],
          harvestPlanYM: cols[7],
          notes: cols[8]
        };
      });

      console.log("ğŸŒ± loadPlantingCSV:", list);
      return list;
    }

    // ============================
    // åç©«å¹´æœˆ Â±1ãƒ¶æœˆ
    // ============================
    function getHarvestYMRange(harvestDate) {
      const d = new Date(harvestDate);
      const list = [];

      for (let offset = -1; offset <= 1; offset++) {
        const tmp = new Date(d);
        tmp.setMonth(tmp.getMonth() + offset);
        const ym = `${tmp.getFullYear()}-${String(tmp.getMonth() + 1).padStart(2, "0")}`;
        list.push(ym);
      }

      return list;
    }

    // ============================
    // å®šæ¤è¨˜éŒ²å€™è£œã‚’æ›´æ–°
    // ============================
    async function updatePlantingRefOptions() {
      console.log("ğŸ”¥ updatePlantingRefOptions ç™ºç«");

      const field = getFinalField();
      const harvestDate = document.getElementById("harvestDate").value;

      console.log("ğŸ§ª field:", field, "harvestDate:", harvestDate);

      if (!field || !harvestDate) return;

      const plantingList = await loadPlantingCSV();
      const ymRange = getHarvestYMRange(harvestDate);

      console.log("ğŸ§ª ymRange:", ymRange);

      const select = document.getElementById("plantingRef");
      select.innerHTML = "<option value=''>è©²å½“ã™ã‚‹å®šæ¤è¨˜éŒ²ã‚’é¸æŠ</option>";

      const filtered = plantingList.filter(
        p => p.field === field && ymRange.includes(p.harvestPlanYM)
      );

      console.log("ğŸ§ª filtered:", filtered);

      filtered.forEach(p => {
        const id = p.plantDate.replace(/-/g, "");
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = `${p.plantDate} / ${p.variety} / ${p.quantity}æ ª`;
        select.appendChild(opt);
      });
    }

    // ============================
    // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿åé›†
    // ============================
    function collectHarvestData() {
      return {
        harvestDate: document.getElementById("harvestDate").value,
        shippingDate: document.getElementById("shippingDate").value,
        worker: getSelectedWorkers("workers_box", "temp_workers"),
        field: getFinalField(),
        amount: document.getElementById("amount").value,
        issue: document.getElementById("issue").value,
        plantingRef: document.getElementById("plantingRef").value
      };
    }

    // ============================
    // ä¿å­˜å‡¦ç†
    // ============================
    async function saveHarvestInner() {
      const data = collectHarvestData();

      if (!data.harvestDate) {
        alert("åç©«æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      const dateStr = data.harvestDate.replace(/-/g, "");

      const csvLine = [
        data.harvestDate,
        data.shippingDate,
        data.worker,
        data.field,
        data.amount,
        data.issue.replace(/[\r\n,]/g, " "),
        data.plantingRef
      ].join(",");

      await saveLog("harvest", dateStr, data, csvLine);

      alert("GitHubã«ä¿å­˜ã—ã¾ã—ãŸ");
    }

    window.saveHarvest = saveHarvestInner;

    // æ—¥ä»˜åˆæœŸå€¤
    const today = new Date().toISOString().slice(0, 10);
    document.getElementById("harvestDate").value = today;
    document.getElementById("shippingDate").value = today;
  </script>
</body>
</html>